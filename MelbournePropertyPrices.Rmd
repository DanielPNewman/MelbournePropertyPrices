---
title: "MelbournePropertyPrices"
author: "Daniel P Newman"
date: "29 September 2016"
output: 
  html_document: 
    keep_md: yes
---

```{r Set wd load and clean data, warning=FALSE}
#Note to run the animation you will have to instal Imagemagik from http://www.imagemagick.org/script/binary-releases.php
# when you install Imagemagik remember to select the "instal legacy files" option so convert.exe is included

#Set working directory where this script and the raw excel file are saved 
setwd("C:/Users/Dan/Documents/GitHub/MelbournePropertyPrices")

### Install/load required packages
#List of R packages required for this analysis:
required_packages <- c("ggmap", "readr", "ggplot2", "dplyr", "readxl","tidyr",
                       "stringr", "gganimate","animation")
#Install required_packages:
new.packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
#Load required_packages:
lapply(required_packages, require, character.only = TRUE)

#Set decimal points and disable scientific notation
options(digits=3, scipen=999) 

###Load Map
# Can download using get_map function:
# Melbourne <- get_map(location = 'Melbourne, Australia', zoom = 10, maptype="terrain")
# But I saved it to workind directory so can load it and work offline:
load("Melbourne.rda")

###Load Apartment price data
# Got this data here http://www.dtpli.vic.gov.au/property-and-land-titles/property-information/property-prices ...
# ...but saved it to workind directory so can load it and work offline
suburb_Apartment_2015<-read_excel("suburb_unit_2015.xls", col_names=F, skip = 3) %>% 
            na.omit() %>%
            distinct() %>%
            mutate(`Property Type`="Apartment")
#Load House Price Data and row bind it to Apartment price data 
property_2005_2015<-read_excel("suburb_house_2015.xls", col_names=F, skip = 3) %>% 
            na.omit() %>%
            distinct() %>%
            mutate(`Property Type`="House") %>%
            bind_rows(suburb_Apartment_2015)
rm(suburb_Apartment_2015)


#rename the columns 
names(property_2005_2015)<-c("suburb", 2005:2015, "Prelim 2016", "Change 2014-2015", "Change 2005-2015", "Growth PA 2005-2015","Property Type")

# assuming that "-" and "0" means data not available (NA), 
property_2005_2015[property_2005_2015 == 0] <- NA
property_2005_2015[property_2005_2015 == "-"] <- NA


## Read in the lat/long data:
# Also saved it to workind directory so can load it and work offline:
lat_long<-read_csv("Australian_Post_Codes_Lat_Lon.csv")  %>% 
    mutate(postcode=as.character(postcode)) %>%
    distinct() %>%
    select(-dc, -type)


#create VIC only lat_long
VIC_lat_long<- lat_long %>% 
    filter(state=="VIC") %>%
    select(-postcode) %>%
    distinct() %>% 
    filter(suburb %in%  property_2005_2015$suburb)

#Merge VIC_lat_long into property_2005_2015
property_2005_2015<- full_join(property_2005_2015, VIC_lat_long,  by=c("suburb"))
rm(VIC_lat_long)


#melt from wide to long format
property_2005_2015<-property_2005_2015 %>% 
    gather(key=Year, value=`Median Price ($)`, -suburb, -lon, -lat, -state, -`Property Type`, -`Change 2014-2015`, -`Change 2005-2015`, -`Growth PA 2005-2015`) %>%
    mutate(`Median Price ($)`=as.numeric(`Median Price ($)`)) #,
           # `Change 2005-2015`=as.numeric(`Change 2005-2015`))


```


## Map

```{r map, warning=FALSE}

p1<-ggmap(Melbourne) + 
    geom_point(data = property_2005_2015, 
               aes(x =lon, y= lat, frame = Year, size=`Median Price ($)`, 
                   colour = `Median Price ($)`), alpha=.75, shape="$") +
        scale_colour_gradientn(colours=rainbow(5)) +
        scale_radius (range = c(4, 14), trans = "identity", guide = "legend") +
    facet_wrap(~`Property Type`) +
    ggtitle("Median Melbourne Property Prices ($) from 2005-2016 \n")

p1 <- p1 + theme(aspect.ratio=1) +
        theme(axis.title.x = element_blank(), 
            axis.text.x  =  element_blank(),
            axis.title.x = element_blank(),
            axis.ticks.x=element_blank(),
            axis.text.y  =  element_blank(), 
            axis.title.y = element_blank(),
            axis.ticks.y=element_blank(),
            legend.title = element_text(size=12, face="bold"),
            legend.text = element_text(size = 12, face = "bold"),
            strip.text.x = element_text(size=12, face="bold"),
            plot.title = element_text(size = 14, face = "bold"),
            legend.position="right")  

#Save the .gif to working directory
gg_animate(p1, 'Melbourne.gif', ani.width = 1000, ani.height = 600, interval = 0.75)

#show the gif in the graphics pannel
gg_animate(p1)


```



